var q=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var j=(o,e)=>{for(var t in e)q(o,t,{get:e[t],enumerable:!0})},H=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of I(e))!F.call(o,r)&&r!==t&&q(o,r,{get:()=>e[r],enumerable:!(s=A(e,r))||s.enumerable});return o};var U=o=>H(q({},"__esModule",{value:!0}),o);var O={};j(O,{createApiFetcher:()=>S,fetchf:()=>x});module.exports=U(O);var b=class{logger;requestErrorService;constructor(e,t){this.logger=e,this.requestErrorService=t}process(e){var s;(s=this.logger)!=null&&s.warn&&this.logger.warn("API ERROR",e);let t=e;typeof e=="string"&&(t=new Error(e)),this.requestErrorService&&(typeof this.requestErrorService.process<"u"?this.requestErrorService.process(t):typeof this.requestErrorService=="function"&&this.requestErrorService(t))}};var g=class o extends Error{response;request;constructor(e,t,s){super(e),this.name="RequestError",this.message=e,this.request=t,this.response=s,Error.captureStackTrace(this,o)}};async function C(o,e){if(!e)return o;let t=Array.isArray(e)?e:[e],s={...o};for(let r of t)s=await r(s);return s}async function E(o,e){if(!e)return o;let t=Array.isArray(e)?e:[e],s=o;for(let r of t)s=await r(s);return s}var f=class{requestInstance;baseURL="";timeout=3e4;cancellable=!1;rejectCancelled=!1;strategy="reject";method="get";flattenResponse=!1;defaultResponse=null;fetcher;logger;onError;requestsQueue;retry={retries:0,delay:1e3,maxDelay:3e4,backoff:1.5,retryOn:[408,409,425,429,500,502,503,504],shouldRetry:async()=>!0};config;constructor({fetcher:e=null,timeout:t=null,rejectCancelled:s=!1,strategy:r=null,flattenResponse:i=null,defaultResponse:l={},logger:n=null,onError:a=null,...u}){this.fetcher=e,this.timeout=t??this.timeout,this.strategy=r??this.strategy,this.cancellable=u.cancellable||this.cancellable,this.rejectCancelled=s||this.rejectCancelled,this.flattenResponse=i??this.flattenResponse,this.defaultResponse=l,this.logger=n||(globalThis?globalThis.console:null)||null,this.onError=a,this.requestsQueue=new WeakMap,this.baseURL=u.baseURL||u.apiUrl||"",this.method=u.method||this.method,this.config=u,this.retry={...this.retry,...u.retry||{}},this.requestInstance=this.isCustomFetcher()?e.create({...u,baseURL:this.baseURL,timeout:this.timeout}):null}getInstance(){return this.requestInstance}replaceUrlPathParams(e,t){return t?e.replace(/:[a-zA-Z]+/gi,s=>{let r=s.substring(1);return String(t[r]?t[r]:s)}):e}appendQueryParams(e,t){if(!t)return e;let s=Object.entries(t).flatMap(([r,i])=>Array.isArray(i)?i.map(l=>`${encodeURIComponent(r)}[]=${encodeURIComponent(l)}`):`${encodeURIComponent(r)}=${encodeURIComponent(String(i))}`).join("&");return e.includes("?")?`${e}&${s}`:s?`${e}?${s}`:e}isJSONSerializable(e){if(e==null)return!1;let t=typeof e;if(t==="string"||t==="number"||t==="boolean")return!0;if(t!=="object")return!1;if(Array.isArray(e))return!0;if(Buffer.isBuffer(e)||e instanceof Date)return!1;let s=Object.getPrototypeOf(e);return s===Object.prototype||s===null||typeof e.toJSON=="function"}buildConfig(e,t,s){let r=s.method||this.method,i=r.toLowerCase(),l=i==="get"||i==="head",n=this.replaceUrlPathParams(e,s.urlPathParams||this.config.urlPathParams),a=s.body||s.data||this.config.body||this.config.data;if(this.isCustomFetcher())return{...s,url:n,method:i,...l?{params:t}:{},...!l&&t&&a?{params:t}:{},...!l&&t&&!a?{data:t}:{},...!l&&a?{data:a}:{}};let u=a||t;delete s.data;let p=!l&&t&&!s.body||!t?n:this.appendQueryParams(n,t),y=p.includes("://")?"":typeof s.baseURL<"u"?s.baseURL:this.baseURL;return{...s,url:y+p,method:r.toUpperCase(),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json;charset=utf-8",...s.headers||this.config.headers||{}},...l?{}:{body:this.isJSONSerializable(u)?typeof u=="string"?u:JSON.stringify(u):u}}}processError(e,t){if(this.isRequestCancelled(e))return;t.onError&&typeof t.onError=="function"&&t.onError(e),new b(this.logger,this.onError).process(e)}async outputErrorResponse(e,t){let s=this.isRequestCancelled(e),r=t.strategy||this.strategy,i=typeof t.rejectCancelled<"u"?t.rejectCancelled:this.rejectCancelled,l=typeof t.defaultResponse<"u"?t.defaultResponse:this.defaultResponse;return s&&!i?l:r==="silent"?(await new Promise(()=>null),l):r==="reject"?Promise.reject(e):l}isRequestCancelled(e){return e.name==="AbortError"||e.name==="CanceledError"}isCustomFetcher(){return this.fetcher!==null}addCancellationToken(e){if(!this.cancellable&&!e.cancellable)return{};if(typeof e.cancellable<"u"&&!e.cancellable)return{};if(typeof AbortController>"u")return console.error("AbortController is unavailable."),{};let t=this.requestsQueue.get(e);t&&t.abort();let s=new AbortController;if(!this.isCustomFetcher()){let r=setTimeout(()=>{let i=new Error(`[TimeoutError]: The ${e.url} request was aborted due to timeout`);throw i.name="TimeoutError",i.code=23,s.abort(i),clearTimeout(r),i},e.timeout||this.timeout)}return this.requestsQueue.set(e,s),{signal:s.signal}}async request(e,t=null,s=null){var P,w;let r=null,i=s||{},l=this.buildConfig(e,t,i),n={...this.addCancellationToken(l),...l},{retries:a,delay:u,backoff:p,retryOn:d,shouldRetry:y,maxDelay:m}={...this.retry,...(n==null?void 0:n.retry)||{}},h=0,R=u;for(;h<=a;)try{if(n=await C(n,n.onRequest),n=await C(n,this.config.onRequest),this.isCustomFetcher())r=await this.requestInstance.request(n);else if(r=await globalThis.fetch(n.url,n),r.config=n,r.ok)r.data=await r.json();else throw r.data=null,new g(`fetchf() Request Failed! Status: ${r.status||null}`,n,r);return r=await E(r,n.onResponse),r=await E(r,this.config.onResponse),this.processResponseData(r,n)}catch(c){if(h===a||!await y(c,h)||!(d!=null&&d.includes((r==null?void 0:r.status)||((P=c==null?void 0:c.response)==null?void 0:P.status)||(c==null?void 0:c.status))))return this.processError(c,n),this.outputErrorResponse(c,n);(w=this.logger)!=null&&w.warn&&this.logger.warn(`Attempt ${h+1} failed. Retrying in ${R}ms...`),await this.delay(R),R*=p,R=Math.min(R,m),h++}return this.processResponseData(r,n)}async delay(e){return new Promise(t=>setTimeout(()=>t(!0),e))}processResponseData(e,t){let s=typeof t.defaultResponse<"u"?t.defaultResponse:this.defaultResponse;return e?(t.flattenResponse||this.flattenResponse)&&typeof e.data<"u"?typeof e.data=="object"&&typeof e.data.data<"u"&&Object.keys(e.data).length===1?e.data.data:e.data:typeof e=="object"&&e.constructor===Object&&Object.keys(e).length===0?s:e:s}};function S(o){let e=o.endpoints,t=new f(o);function s(){return t.getInstance()}function r(a){return console.error(`${a} endpoint must be added to 'endpoints'.`),Promise.resolve(null)}async function i(a,u={},p={},d={}){let m={...e[a]};return await t.request(m.url,u,{...m,...d,urlPathParams:p})}function l(a){return a in n?n[a]:e[a]?n.request.bind(null,a):r.bind(null,a)}let n={config:o,endpoints:e,requestHandler:t,getInstance:s,request:i};return new Proxy(n,{get:(a,u)=>l(u)})}async function x(o,e={}){return new f(e).request(o,e.body||e.data||e.params,e)}0&&(module.exports={createApiFetcher,fetchf});
//# sourceMappingURL=index.js.map