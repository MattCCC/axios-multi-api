var f=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var C=(a,e)=>{for(var t in e)f(a,t,{get:e[t],enumerable:!0})},S=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of E(e))!q.call(a,n)&&n!==t&&f(a,n,{get:()=>e[n],enumerable:!(r=m(e,n))||r.enumerable});return a};var w=a=>S(f({},"__esModule",{value:!0}),a),g=(a,e,t,r)=>{for(var n=r>1?void 0:r?m(e,t):e,s=a.length-1,o;s>=0;s--)(o=a[s])&&(n=(r?o(e,t,n):o(n))||n);return r&&n&&f(e,t,n),n};var A={};C(A,{ApiHandler:()=>d,RequestErrorHandler:()=>h,RequestHandler:()=>p,createApiFetcher:()=>I});module.exports=w(A);var R=require("js-magic");var y=require("js-magic");var h=class{logger;requestErrorService;constructor(e,t){this.logger=e,this.requestErrorService=t}process(e){var r;(r=this.logger)!=null&&r.warn&&this.logger.warn("API ERROR",e);let t=e;typeof e=="string"&&(t=new Error(e)),this.requestErrorService&&(typeof this.requestErrorService.process<"u"?this.requestErrorService.process(t):typeof this.requestErrorService=="function"&&this.requestErrorService(t))}};var p=class{requestInstance;baseURL="";timeout=3e4;cancellable=!1;strategy="reject";flattenResponse=!0;defaultResponse=null;fetcher;logger;requestErrorService;requestsQueue;constructor({fetcher:e=null,baseURL:t="",timeout:r=null,cancellable:n=!1,strategy:s=null,flattenResponse:o=null,defaultResponse:i={},logger:l=null,onError:u=null,...c}){this.fetcher=e,this.timeout=r??this.timeout,this.strategy=s??this.strategy,this.cancellable=n||this.cancellable,this.flattenResponse=o??this.flattenResponse,this.defaultResponse=i,this.logger=l||(globalThis?globalThis.console:null)||null,this.requestErrorService=u,this.requestsQueue=new Map,this.baseURL=t||c.apiUrl||"",this.requestInstance=this.isCustomFetcher()?e.create({...c,baseURL:this.baseURL,timeout:this.timeout}):globalThis.fetch}getInstance(){return this.requestInstance}__get(e){return e in this?this[e]:this.handleRequest.bind(this,e)}appendQueryParams(e,t){let r=Object.entries(t).flatMap(([n,s])=>Array.isArray(s)?s.map(o=>`${encodeURIComponent(n)}[]=${encodeURIComponent(o)}`):`${encodeURIComponent(n)}=${encodeURIComponent(s)}`).join("&");return e.includes("?")?`${e}&${r}`:r?`${e}?${r}`:e}isJSONSerializable(e){if(e==null)return!1;let t=typeof e;if(t==="string"||t==="number"||t==="boolean")return!0;if(t!=="object")return!1;if(Array.isArray(e))return!0;if(Buffer.isBuffer(e)||e instanceof Date)return!1;let r=Object.getPrototypeOf(e);return r===Object.prototype||r===null||typeof e.toJSON=="function"}buildRequestConfig(e,t,r,n){let s=e.toLowerCase(),o=s==="get"||s==="head";if(this.isCustomFetcher())return{...n,url:t,method:s,...o?{params:r}:{},...!o&&r&&n.data?{params:r}:{},...!o&&r&&!n.data?{data:r}:{},...!o&&n.data?{data:n.data}:{}};let i=n.body||n.data||r;return delete n.data,{...n,url:!o&&r&&!n.body||!r?t:this.appendQueryParams(t,r),method:e.toUpperCase(),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json;charset=utf-8",...n.headers||{}},...o?{}:{body:this.isJSONSerializable(i)?typeof i=="string"?i:JSON.stringify(i):i}}}processRequestError(e,t){if(this.isRequestCancelled(e))return;t.onError&&typeof t.onError=="function"&&t.onError(e),new h(this.logger,this.requestErrorService).process(e)}async outputErrorResponse(e,t){let r=this.isRequestCancelled(e),n=t.strategy||this.strategy;return r&&!t.rejectCancelled?this.defaultResponse:n==="silent"?(await new Promise(()=>null),this.defaultResponse):n==="reject"||n==="throwError"?Promise.reject(e):this.defaultResponse}isRequestCancelled(e){return e.name==="AbortError"||e.name==="CanceledError"}isCustomFetcher(){return this.fetcher!==null}addCancellationToken(e){if(!this.cancellable&&!e.cancellable)return{};if(typeof e.cancellable<"u"&&!e.cancellable)return{};if(typeof AbortController>"u")return console.error("AbortController is unavailable."),{};let{method:t,baseURL:r,url:n,params:s,data:o}=e,i=JSON.stringify([t,r,n,s,o]).substring(0,55**5),l=this.requestsQueue.get(i);l&&l.abort();let u=new AbortController;if(!this.isCustomFetcher()){let c=setTimeout(()=>{let b=new Error(`[TimeoutError]: The ${n} request was aborted due to timeout`);b.name="TimeoutError",b.code=23,u.abort(b),clearTimeout(c)},e.timeout||this.timeout)}return this.requestsQueue.set(i,u),{signal:u.signal}}async handleRequest(e,t,r=null,n=null){let s=null,o=n||{},i=this.buildRequestConfig(e,t,r,o);i={...this.addCancellationToken(i),...i};try{if(this.isCustomFetcher())s=await this.requestInstance.request(i);else if(s=await globalThis.fetch(this.baseURL+t,i),s.ok)s=await s.json();else{let l=new Error(`HTTP error! Status: ${s.status}`);throw l.response=s,l}}catch(l){return this.processRequestError(l,i),this.outputErrorResponse(l,i)}return this.processResponseData(s)}processResponseData(e){return this.flattenResponse?e.data?typeof e.data=="object"&&typeof e.data.data<"u"&&Object.keys(e.data).length===1?e.data.data:e.data:this.defaultResponse:e}};p=g([y.applyMagic],p);var d=class{requestHandler;endpoints;logger;constructor(e){this.endpoints=e.endpoints,this.logger=e.logger,this.requestHandler=new p(e)}getInstance(){return this.requestHandler.getInstance()}__get(e){return e in this?this[e]:this.endpoints[e]?this.handleRequest.bind(this,e):this.handleNonImplemented.bind(this,e)}async handleRequest(...e){let t=e[0],r=this.endpoints[t],n=e[1]||{},s=e[2]||{},o=e[3]||{},i=r.url.replace(/:[a-z]+/gi,c=>s[c.substring(1)]?s[c.substring(1)]:c),l=null,u={...r};return delete u.url,delete u.method,l=await this.requestHandler[(r.method||"get").toLowerCase()](i,n,{...o,...u}),l}handleNonImplemented(e){var t;return(t=this.logger)!=null&&t.log&&this.logger.log(`${e} endpoint not implemented.`),Promise.resolve(null)}};d=g([R.applyMagic],d);var I=a=>new d(a);0&&(module.exports={ApiHandler,RequestErrorHandler,RequestHandler,createApiFetcher});
//# sourceMappingURL=index.js.map