var g=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var H=(o,e)=>{for(var t in e)g(o,t,{get:e[t],enumerable:!0})},S=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of A(e))!I.call(o,s)&&s!==t&&g(o,s,{get:()=>e[s],enumerable:!(r=w(e,s))||r.enumerable});return o};var j=o=>S(g({},"__esModule",{value:!0}),o);var x={};H(x,{createApiFetcher:()=>F,fetchf:()=>U});module.exports=j(x);var m=class{logger;requestErrorService;constructor(e,t){this.logger=e,this.requestErrorService=t}process(e){var r;(r=this.logger)!=null&&r.warn&&this.logger.warn("API ERROR",e);let t=e;typeof e=="string"&&(t=new Error(e)),this.requestErrorService&&(typeof this.requestErrorService.process<"u"?this.requestErrorService.process(t):typeof this.requestErrorService=="function"&&this.requestErrorService(t))}};var y=class o extends Error{response;request;constructor(e,t,r){super(e),this.name="RequestError",this.message=e,this.request=t,this.response=r,Error.captureStackTrace(this,o)}};async function b(o,e){if(!e)return o;let t=Array.isArray(e)?e:[e],r={...o};for(let s of t)r=await s(r);return r}async function q(o,e){if(!e)return o;let t=Array.isArray(e)?e:[e],r=o;for(let s of t)r=await s(r);return r}var R=class{requestInstance;baseURL="";timeout=3e4;cancellable=!1;rejectCancelled=!1;strategy="reject";method="get";flattenResponse=!0;defaultResponse=null;fetcher;logger;onError;requestsQueue;retry={retries:0,delay:1e3,maxDelay:3e4,backoff:1.5,retryOn:[408,409,425,429,500,502,503,504],shouldRetry:async()=>!0};config;constructor({fetcher:e=null,timeout:t=null,rejectCancelled:r=!1,strategy:s=null,flattenResponse:l=null,defaultResponse:n={},logger:u=null,onError:i=null,...a}){this.fetcher=e,this.timeout=t??this.timeout,this.strategy=s??this.strategy,this.cancellable=a.cancellable||this.cancellable,this.rejectCancelled=r||this.rejectCancelled,this.flattenResponse=l??this.flattenResponse,this.defaultResponse=n,this.logger=u||(globalThis?globalThis.console:null)||null,this.onError=i,this.requestsQueue=new Map,this.baseURL=a.baseURL||a.apiUrl||"",this.method=a.method||this.method,this.config=a,this.retry={...this.retry,...a.retry||{}},this.requestInstance=this.isCustomFetcher()?e.create({...a,baseURL:this.baseURL,timeout:this.timeout}):null}getInstance(){return this.requestInstance}replaceUrlPathParams(e,t){return e.replace(/:[a-zA-Z]+/gi,r=>{let s=r.substring(1);return String(t[s]?t[s]:r)})}appendQueryParams(e,t){let r=Object.entries(t).flatMap(([s,l])=>Array.isArray(l)?l.map(n=>`${encodeURIComponent(s)}[]=${encodeURIComponent(n)}`):`${encodeURIComponent(s)}=${encodeURIComponent(String(l))}`).join("&");return e.includes("?")?`${e}&${r}`:r?`${e}?${r}`:e}isJSONSerializable(e){if(e==null)return!1;let t=typeof e;if(t==="string"||t==="number"||t==="boolean")return!0;if(t!=="object")return!1;if(Array.isArray(e))return!0;if(Buffer.isBuffer(e)||e instanceof Date)return!1;let r=Object.getPrototypeOf(e);return r===Object.prototype||r===null||typeof e.toJSON=="function"}buildConfig(e,t,r){let s=r.method||this.method,l=s.toLowerCase(),n=l==="get"||l==="head",u=this.replaceUrlPathParams(e,r.urlPathParams||this.config.urlPathParams),i=r.body||r.data||this.config.body||this.config.data;if(this.isCustomFetcher())return{...r,url:u,method:l,...n?{params:t}:{},...!n&&t&&i?{params:t}:{},...!n&&t&&!i?{data:t}:{},...!n&&i?{data:i}:{}};let a=i||t;return delete r.data,{...r,url:this.baseURL+(!n&&t&&!r.body||!t?u:this.appendQueryParams(u,t)),method:s.toUpperCase(),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json;charset=utf-8",...r.headers||this.config.headers||{}},...n?{}:{body:this.isJSONSerializable(a)?typeof a=="string"?a:JSON.stringify(a):a}}}processError(e,t){if(this.isRequestCancelled(e))return;t.onError&&typeof t.onError=="function"&&t.onError(e),new m(this.logger,this.onError).process(e)}async outputErrorResponse(e,t){let r=this.isRequestCancelled(e),s=t.strategy||this.strategy,l=typeof t.rejectCancelled<"u"?t.rejectCancelled:this.rejectCancelled,n=typeof t.defaultResponse<"u"?t.defaultResponse:this.defaultResponse;return r&&!l?n:s==="silent"?(await new Promise(()=>null),n):s==="reject"?Promise.reject(e):n}isRequestCancelled(e){return e.name==="AbortError"||e.name==="CanceledError"}isCustomFetcher(){return this.fetcher!==null}addCancellationToken(e){if(!this.cancellable&&!e.cancellable)return{};if(typeof e.cancellable<"u"&&!e.cancellable)return{};if(typeof AbortController>"u")return console.error("AbortController is unavailable."),{};let{method:t,baseURL:r,url:s,params:l,data:n}=e,u=JSON.stringify([t,r,s,l,n]).substring(0,55**5),i=this.requestsQueue.get(u);i&&i.abort();let a=new AbortController;if(!this.isCustomFetcher()){let h=setTimeout(()=>{let p=new Error(`[TimeoutError]: The ${s} request was aborted due to timeout`);throw p.name="TimeoutError",p.code=23,a.abort(p),clearTimeout(h),p},e.timeout||this.timeout)}return this.requestsQueue.set(u,a),{signal:a.signal}}async request(e,t=null,r=null){var E,P;let s=null,l=r||{},n=this.buildConfig(e,t,l);n={...this.addCancellationToken(n),...n};let{retries:u,delay:i,backoff:a,retryOn:h,shouldRetry:p,maxDelay:C}={...this.retry,...(n==null?void 0:n.retry)||{}},d=0,f=i;for(;d<=u;)try{if(n=await b(n,n.onRequest),n=await b(n,this.config.onRequest),this.isCustomFetcher())s=await this.requestInstance.request(n);else if(s=await globalThis.fetch(n.url,n),s.config=n,s.ok)s.data=await s.json();else throw s.data=null,new y("fetchf() Request Failed! Status: ${response.status}",n,s);return s=await q(s,n.onResponse),s=await q(s,this.config.onResponse),this.processResponseData(s,n)}catch(c){if(d===u||!await p(c,d)||!(h!=null&&h.includes((s==null?void 0:s.status)||((E=c==null?void 0:c.response)==null?void 0:E.status)||(c==null?void 0:c.status))))return this.processError(c,n),this.outputErrorResponse(c,n);(P=this.logger)!=null&&P.warn&&this.logger.warn(`Attempt ${d+1} failed. Retrying in ${f}ms...`),await this.delay(f),f*=a,f=Math.min(f,C),d++}return this.processResponseData(s,n)}async delay(e){return new Promise(t=>setTimeout(()=>t(!0),e))}processResponseData(e,t){let r=typeof t.defaultResponse<"u"?t.defaultResponse:this.defaultResponse;return e?(t.flattenResponse||this.flattenResponse)&&typeof e.data<"u"?typeof e.data=="object"&&typeof e.data.data<"u"&&Object.keys(e.data).length===1?e.data.data:e.data:typeof e=="object"&&e.constructor===Object&&Object.keys(e).length===0?r:e:r}};function F(o){let e=o.endpoints,t=new R(o);function r(){return t.getInstance()}function s(i){return console.error(`${i} endpoint must be added to 'endpoints'.`),Promise.resolve(null)}async function l(i,a={},h={},p={}){let d={...e[i]};return await t.request(d.url,a,{...d,...p,urlPathParams:h})}function n(i){return i in u?u[i]:e[i]?u.request.bind(null,i):s.bind(null,i)}let u={config:o,endpoints:e,requestHandler:t,getInstance:r,request:l};return new Proxy(u,{get:(i,a)=>n(a)})}async function U(o,e={}){return new R(e).request(o,e.body||e.data||e.params,e)}0&&(module.exports={createApiFetcher,fetchf});
//# sourceMappingURL=index.js.map