var y=class{logger;requestErrorService;constructor(e,t){this.logger=e,this.requestErrorService=t}process(e){var r;(r=this.logger)!=null&&r.warn&&this.logger.warn("API ERROR",e);let t=e;typeof e=="string"&&(t=new Error(e)),this.requestErrorService&&(typeof this.requestErrorService.process<"u"?this.requestErrorService.process(t):typeof this.requestErrorService=="function"&&this.requestErrorService(t))}};var R=class c extends Error{response;request;constructor(e,t,r){super(e),this.name="RequestError",this.message=e,this.request=t,this.response=r,Error.captureStackTrace(this,c)}};var m=class{requestInstance;baseURL="";timeout=3e4;cancellable=!1;rejectCancelled=!1;strategy="reject";method="get";flattenResponse=!0;defaultResponse=null;fetcher;logger;requestErrorService;requestsQueue;retry={retries:0,delay:1e3,maxDelay:3e4,backoff:1.5,retryOn:[408,409,425,429,500,502,503,504],shouldRetry:()=>!0};config;constructor({fetcher:e=null,timeout:t=null,cancellable:r=!1,rejectCancelled:n=!1,strategy:i=null,flattenResponse:s=null,defaultResponse:l={},logger:o=null,onError:a=null,...u}){this.fetcher=e,this.timeout=t??this.timeout,this.strategy=i??this.strategy,this.cancellable=r||this.cancellable,this.rejectCancelled=n||this.rejectCancelled,this.flattenResponse=s??this.flattenResponse,this.defaultResponse=l,this.logger=o||(globalThis?globalThis.console:null)||null,this.requestErrorService=a,this.requestsQueue=new Map,this.baseURL=u.baseURL||u.apiUrl||"",this.method=u.method||this.method,this.config=u,this.retry={...this.retry,...u.retry||{}},this.requestInstance=this.isCustomFetcher()?e.create({...u,baseURL:this.baseURL,timeout:this.timeout}):globalThis.fetch}getInstance(){return this.requestInstance}replaceUriParams(e,t){return e.replace(/:[a-zA-Z]+/gi,r=>{let n=r.substring(1);return String(t[n]?t[n]:r)})}appendQueryParams(e,t){let r=Object.entries(t).flatMap(([n,i])=>Array.isArray(i)?i.map(s=>`${encodeURIComponent(n)}[]=${encodeURIComponent(s)}`):`${encodeURIComponent(n)}=${encodeURIComponent(String(i))}`).join("&");return e.includes("?")?`${e}&${r}`:r?`${e}?${r}`:e}isJSONSerializable(e){if(e==null)return!1;let t=typeof e;if(t==="string"||t==="number"||t==="boolean")return!0;if(t!=="object")return!1;if(Array.isArray(e))return!0;if(Buffer.isBuffer(e)||e instanceof Date)return!1;let r=Object.getPrototypeOf(e);return r===Object.prototype||r===null||typeof e.toJSON=="function"}buildConfig(e,t,r){let n=r.method||this.method,i=n.toLowerCase(),s=i==="get"||i==="head",l=this.replaceUriParams(e,r.uriParams||this.config.uriParams),o=r.body||r.data||this.config.body||this.config.data;if(this.isCustomFetcher())return{...r,url:l,method:i,...s?{params:t}:{},...!s&&t&&o?{params:t}:{},...!s&&t&&!o?{data:t}:{},...!s&&o?{data:o}:{}};let a=o||t;return delete r.data,{...r,url:this.baseURL+(!s&&t&&!r.body||!t?l:this.appendQueryParams(l,t)),method:n.toUpperCase(),headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json;charset=utf-8",...r.headers||this.config.headers||{}},...s?{}:{body:this.isJSONSerializable(a)?typeof a=="string"?a:JSON.stringify(a):a}}}processError(e,t){if(this.isRequestCancelled(e))return;t.onError&&typeof t.onError=="function"&&t.onError(e),new y(this.logger,this.requestErrorService).process(e)}async outputErrorResponse(e,t){let r=this.isRequestCancelled(e),n=t.strategy||this.strategy,i=typeof t.rejectCancelled<"u"?t.rejectCancelled:this.rejectCancelled,s=typeof t.defaultResponse<"u"?t.defaultResponse:this.defaultResponse;return r&&!i?s:n==="silent"?(await new Promise(()=>null),s):n==="reject"?Promise.reject(e):s}isRequestCancelled(e){return e.name==="AbortError"||e.name==="CanceledError"}isCustomFetcher(){return this.fetcher!==null}addCancellationToken(e){if(!this.cancellable&&!e.cancellable)return{};if(typeof e.cancellable<"u"&&!e.cancellable)return{};if(typeof AbortController>"u")return console.error("AbortController is unavailable."),{};let{method:t,baseURL:r,url:n,params:i,data:s}=e,l=JSON.stringify([t,r,n,i,s]).substring(0,55**5),o=this.requestsQueue.get(l);o&&o.abort();let a=new AbortController;if(!this.isCustomFetcher()){let u=setTimeout(()=>{let h=new Error(`[TimeoutError]: The ${n} request was aborted due to timeout`);h.name="TimeoutError",h.code=23,a.abort(h),clearTimeout(u)},e.timeout||this.timeout)}return this.requestsQueue.set(l,a),{signal:a.signal}}async request(e,t=null,r=null){var g,q;let n=null,i=r||{},s=this.buildConfig(e,t,i);s={...this.addCancellationToken(s),...s};let{retries:l,delay:o,backoff:a,retryOn:u,shouldRetry:h,maxDelay:b}=this.retry,p=0,f=o;for(;p<=l;)try{if(this.isCustomFetcher())n=await this.requestInstance.request(s);else if(n=await globalThis.fetch(s.url,s),n.ok)n=await n.json();else throw new R("fetchf() Request Failed! Status: ${response.status}",s,n);return this.processResponseData(n,s)}catch(d){if(p===l||!h(d,p)||!(u!=null&&u.includes((n==null?void 0:n.status)||((g=d==null?void 0:d.response)==null?void 0:g.status)||(d==null?void 0:d.status))))return this.processError(d,s),this.outputErrorResponse(d,s);(q=this.logger)!=null&&q.warn&&this.logger.warn(`Attempt ${p+1} failed. Retrying in ${f}ms...`),await this.delay(f),f*=a,f=Math.min(f,b),p++}return this.processResponseData(n,s)}async delay(e){return new Promise(t=>setTimeout(()=>t(!0),e))}processResponseData(e,t){let r=typeof t.defaultResponse<"u"?t.defaultResponse:this.defaultResponse;return e?(t.flattenResponse||this.flattenResponse)&&typeof e.data<"u"?typeof e.data=="object"&&typeof e.data.data<"u"&&Object.keys(e.data).length===1?e.data.data:e.data:typeof e=="object"&&e.constructor===Object&&Object.keys(e).length===0?r:e:r}};function H(c){let e=c.endpoints,t=new m(c);function r(){return t.getInstance()}function n(o){return console.error(`${o} endpoint must be added to 'endpoints'.`),Promise.resolve(null)}async function i(o,a={},u={},h={}){let p={...e[o]};return await t.request(p.url,a,{...p,...h,uriParams:u})}function s(o){return o in l?l[o]:e[o]?l.request.bind(null,o):n.bind(null,o)}let l={config:c,endpoints:e,requestHandler:t,getInstance:r,request:i};return new Proxy(l,{get:(o,a)=>s(a)})}async function x(c,e={}){return new m(e).request(c,e.body||e.data||e.params,e)}export{H as createApiFetcher,x as fetchf};
//# sourceMappingURL=index.mjs.map